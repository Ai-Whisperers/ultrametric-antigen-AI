# V5.12.2 Categorized Review of All 278 norm() Calls

**Legend:**
- ✅ CORRECT - No fix needed
- ❌ NEEDS FIX - Should use hyperbolic distance
- ⚠️ REVIEW - Needs manual inspection

---

## Category Summary

| Category | Count | Description |
|----------|-------|-------------|
| Inside hyperbolic helper | ~60 | Extracting Euclidean norm for conversion formula |
| LayerNorm/BatchNorm | ~15 | `self.norm(x)` is nn.LayerNorm, not geometric |
| Direction normalization | ~25 | `v / norm(v)` for unit vectors |
| Ball projection/clamping | ~20 | Checking `norm < max_radius` |
| Exp/Log map formulas | ~30 | Correct usage inside hyperbolic formulas |
| Convergence checks | ~5 | `if norm(update) < tol` |
| Gradient norms | ~5 | Parameter/gradient magnitude |
| 3D physical coordinates | ~10 | Not Poincaré ball embeddings |
| Intentionally Euclidean | ~15 | `euclidean_distance()`, `cosine_distance()` |
| p-adic norm | ~5 | Different mathematical object |
| **NEEDS FIX** | ~88 | Radii, distances, centroids on hyperbolic embeddings |

---

## Detailed Review

### 1-6: `src\_experimental\diffusion\structure_gen.py` and equivariant layers

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 1 | 305 | `h_new = self.norm(h_new)` | LayerNorm | ✅ CORRECT |
| 2 | 90 | `v_norms = torch.linalg.norm(vectors, dim=-1)` | GVP vector norms | ✅ CORRECT (3D vectors) |
| 3 | 178 | `edge_dist = torch.linalg.norm(edge_vec, dim=-1)` | 3D edge distances | ✅ CORRECT |
| 4 | 286 | `edge_dist = torch.linalg.norm(edge_vec, dim=-1)` | 3D edge distances | ✅ CORRECT |
| 5 | 418 | `scalar = self.norm(scalar)` | LayerNorm | ✅ CORRECT |
| 6 | 505 | `edge_dist = torch.linalg.norm(edge_vec, dim=-1)` | 3D edge distances | ✅ CORRECT |

### 7: `src\_experimental\equivariant\spherical_harmonics.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 7 | 190 | `norms = torch.linalg.norm(vectors, dim=-1, keepdim=True)` | 3D vectors for spherical harmonics | ✅ CORRECT |

### 8-13: `src\_experimental\graphs\hyperbolic_gnn.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 8 | 116 | `norm = x.norm(dim=-1, keepdim=True).clamp(...)` | Möbius scalar (inside formula) | ✅ CORRECT |
| 9 | 143 | `norm = v.norm(dim=-1, keepdim=True).clamp(...)` | exp_map (inside formula) | ✅ CORRECT |
| 10 | 177 | `norm = y.norm(dim=-1, keepdim=True).clamp(...)` | log_map (inside formula) | ✅ CORRECT |
| 11 | 184 | `norm = diff.norm(dim=-1, keepdim=True).clamp(...)` | log_map (inside formula) | ✅ CORRECT |
| 12 | 207 | `norm = diff.norm(dim=-1, keepdim=True).clamp(...)` | distance (inside poincare_distance) | ✅ CORRECT |
| 13 | 225 | `norm = x.norm(dim=-1, keepdim=True)` | Ball projection | ✅ CORRECT |

### 14-21: `src\_experimental\implementations\literature\*.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 14 | 311 | `dist = torch.norm(diff, dim=-1, keepdim=True)` | 3D structure coords | ✅ CORRECT |
| 15 | 383 | `dist = torch.norm(coords[row] - coords[col], dim=-1, ...)` | 3D structure coords | ✅ CORRECT |
| 16 | 871 | `np.linalg.norm(ensemble['centroid'])` | Debug print | ⚠️ REVIEW |
| 17 | 278 | `v_norm = torch.norm(v, dim=-1, keepdim=True)` | exp_map formula | ✅ CORRECT |
| 18 | 289 | `result_norm = torch.norm(result, dim=-1, keepdim=True)` | exp_map clamping | ✅ CORRECT |
| 19 | 299 | `diff_norm = torch.norm(diff, dim=-1, keepdim=True)` | log_map formula | ✅ CORRECT |
| 20 | 402 | `mu_norm = torch.norm(mu, dim=-1)` | KL divergence formula | ✅ CORRECT |
| 21 | 1191 | `z_norms = torch.norm(z_hyp, dim=-1)` | Debug/viz output | ❌ NEEDS FIX (hyperbolic radii) |

### 22: `src\_experimental\information\fisher_geometry.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 22 | 748 | `direction = direction / direction.norm() * epsilon` | Direction normalization | ✅ CORRECT |

### 23-24: `src\analysis\ancestry\geodesic_interpolator.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 23 | 166 | `v_norm = torch.norm(v, dim=-1, keepdim=True).clamp(...)` | Möbius scalar formula | ✅ CORRECT |
| 24 | 262 | `if torch.norm(weighted_tangent) < self.config.frechet_tolerance` | Convergence check | ✅ CORRECT |

### 25-30: `src\analysis\evolution.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 25 | 526 | `immune = torch.norm(epitope_pressure[pos]).item()` | Pressure magnitude | ⚠️ REVIEW |
| 26 | 724 | `angle = direction / (torch.norm(direction) + 1e-10)` | Direction normalization | ✅ CORRECT |
| 27 | 727 | `angle = profile.embedding / (torch.norm(profile.embedding) + ...)` | Direction normalization | ✅ CORRECT |
| 28 | 731 | `angle = angle / torch.norm(angle)` | Direction normalization | ✅ CORRECT |
| 29 | 761 | `current_norm = torch.norm(embedding, dim=-1, keepdim=True).clamp(...)` | Ball clamping | ✅ CORRECT |
| 30 | 860 | `norm = torch.norm(current, dim=-1, keepdim=True)` | Trajectory clamping | ✅ CORRECT |

### 31-34: `src\analysis\extraterrestrial_aminoacids.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 31-34 | 254-258 | `np.linalg.norm(sample_vec)`, `earth_vec` | Direction normalization for cosine | ✅ CORRECT |

### 35: `src\analysis\protein_landscape.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 35 | 465 | `projection = projection / (direction.norm(dim=-1, keepdim=True) + ...)` | Direction normalization | ✅ CORRECT |

### 36: `src\analysis\rotamer_stability.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 36 | 163 | `r = np.linalg.norm(coords)` | Chi angle 3D coords | ✅ CORRECT |

### 37-45: `src\core\geometry_utils.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 37 | 195 | `x_norm = torch.norm(x, dim=-1, keepdim=True).clamp(...)` | mobius_scalar_mul formula | ✅ CORRECT |
| 38 | 264 | `v_norm = torch.norm(v, dim=-1, keepdim=True).clamp(...)` | exp_map_zero formula | ✅ CORRECT |
| 39 | 289 | `x_norm = torch.norm(x, dim=-1, keepdim=True).clamp(...)` | log_map_zero formula | ✅ CORRECT |
| 40 | 315 | `v_norm = torch.norm(v, dim=-1, keepdim=True).clamp(...)` | exp_map formula | ✅ CORRECT |
| 41 | 345 | `diff_norm = torch.norm(diff, dim=-1, keepdim=True).clamp(...)` | log_map formula | ✅ CORRECT |
| 42 | 384 | `diff_norm = torch.norm(diff, dim=-1)` | Inside poincare_distance | ✅ CORRECT |
| 43 | 425 | `norm = torch.norm(x, dim=-1, keepdim=True)` | project_to_ball | ✅ CORRECT |
| 44 | 473 | `norm = torch.norm(x, dim=-1, keepdim=True).clamp(...)` | project_polar | ✅ CORRECT |
| 45 | 672 | `if torch.norm(update) < eps:` | Convergence check | ✅ CORRECT |

### 46-49: `src\core\metrics.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 46-49 | 402-405 | `torch.norm(z_A_euc[i_idx] - z_A_euc[j_idx], dim=1)` | On z_*_euc (Euclidean embeddings) | ✅ CORRECT |

### 50-51: `src\core\tensor_utils.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 50 | 194 | `norm = torch.norm(tensor, p=2, dim=dim, keepdim=True)` | safe_normalize utility | ✅ CORRECT |
| 51 | 241 | `norm = torch.norm(tensor, p=2, dim=dim, keepdim=True)` | clamp_norm utility | ✅ CORRECT |

### 52: `src\diseases\rheumatoid_arthritis.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 52 | 346 | `shift_magnitude = torch.norm(diff, dim=-1)` | Centroid shift | ❌ NEEDS FIX |

### 53-54: `src\encoders\codon_encoder.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 53 | 138 | `return float(np.linalg.norm(props1 - props2))` | AA property distance | ✅ CORRECT (properties, not embeddings) |
| 54 | 413 | `emb_dist = torch.norm(emb1 - emb2).item()` | Codon similarity | ❌ NEEDS FIX (hyperbolic embeddings) |

### 55-56: `src\encoders\geometric_vector_perceptron.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 55-56 | 137, 151 | `v_norm = torch.norm(v, dim=-1)` | GVP vector norms | ✅ CORRECT (3D vectors) |

### 57: `src\encoders\motor_encoder.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 57 | 268 | `dist = torch.norm(self.state_embedding.weight[i] - ...)` | State transitions | ⚠️ REVIEW |

### 58-62: `src\encoders\padic_amino_acid_encoder.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 58 | 182 | `prop_dist = np.linalg.norm(props1_norm - props2_norm)` | Property distance | ✅ CORRECT |
| 59-62 | 364,498,621,785 | `output = self.norm(output)` | LayerNorm | ✅ CORRECT |

### 63-65: `src\geometry\holographic_poincare.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 63 | 170 | `z_norm = torch.norm(z, dim=-1, keepdim=True)` | Boundary encoding formula | ✅ CORRECT |
| 64 | 251 | `diff = torch.norm(z1_batch - z2_batch, dim=-1)` | holographic_distance | ❌ NEEDS FIX |
| 65 | 294 | `norm = torch.norm(z_current, dim=-1, keepdim=True)` | Conformal flow clamping | ✅ CORRECT |

### 66: `src\geometry\poincare.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 66 | 109 | `norm = torch.norm(z_proj, dim=-1, keepdim=True)` | project_to_poincare | ✅ CORRECT |

### 67-69: `src\losses\epistasis_loss.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 67-69 | 168-174 | `x_norm`, `y_norm`, `diff_norm` | Inside hyperbolic_distance formula | ✅ CORRECT |

### 70: `src\losses\hyperbolic_recon.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 70 | 455 | `if torch.norm(mean - prev_mean) < tol:` | Frechet mean convergence | ✅ CORRECT |

### 71-72: `src\losses\objectives\*.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 71 | 193 | `return torch.norm(latent, p=1, dim=-1)` | L1 norm for length estimate | ⚠️ REVIEW |
| 72 | 231 | `norms = torch.norm(latent, dim=-1)` | Compactness on latent | ❌ NEEDS FIX |

### 73-77: `src\losses\padic\*.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 73 | 84 | `d_latent = torch.norm(z[i_idx] - z[j_idx], dim=1)` | metric_loss | ❌ NEEDS FIX |
| 74-75 | 97-98 | `d_anchor_pos/neg = torch.norm(z[...] - z[...], dim=1)` | ranking_loss | ❌ NEEDS FIX |
| 76-77 | 131-132 | `d_anchor_pos/neg = torch.norm(z[...] - z[...], dim=1)` | ranking_v2 | ❌ NEEDS FIX |

### 78: `src\losses\set_theory_loss.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 78 | 105 | `distances = torch.norm(embeddings, dim=-1)` | Distance from origin | ❌ NEEDS FIX |

### 79-81: `src\models\base_vae.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 79 | 489 | `v_norm = torch.clamp(torch.norm(v, ...), ...)` | exp_map formula | ✅ CORRECT |
| 80 | 509 | `y_norm = torch.clamp(torch.norm(y, ...), ...)` | log_map formula | ✅ CORRECT |
| 81 | 537 | `diff_norm = torch.clamp(torch.norm(diff, ...), ...)` | hyperbolic_distance formula | ✅ CORRECT |

### 82: `src\models\contrastive\concept_aware.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 82 | 445 | `distances = torch.norm(diff, dim=-1)` | Concept distances | ❌ NEEDS FIX |

### 83-84: `src\models\epistasis_module.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 83-84 | 441-442 | `matrix = matrix / (torch.norm(pos_emb, ...) + ...)` | Normalization for matrix | ⚠️ REVIEW |

### 85: `src\models\epsilon_vae.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 85 | 80 | `return self.norm(stacked)` | LayerNorm | ✅ CORRECT |

### 86-87: `src\models\equivariant\layers.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 86 | 290 | `distances = edge_vec.norm(dim=-1)` | 3D edge distances | ✅ CORRECT |
| 87 | 395 | `q_norm = q / (q.norm(dim=-1, keepdim=True) + 1e-8)` | Query normalization | ✅ CORRECT |

### 88-90: `src\models\equivariant\se3_encoder.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 88 | 240 | `dist_from_center = (positions - centroid).norm(...)` | 3D position features | ✅ CORRECT |
| 89-90 | 367, 374 | `norm = pre_hyp.norm(...)`, `hyperbolic.norm(...)` | Ball projection | ✅ CORRECT |

### 91-92: `src\models\fusion\multimodal.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 91-92 | 228, 235 | `norm = x.norm(...)`, `current_norm = hyperbolic.norm(...)` | Ball projection | ✅ CORRECT |

### 93-94: `src\models\gene_specific_vae.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 93-94 | 114, 134 | `x = self.norm(x + ...)` | LayerNorm | ✅ CORRECT |

### 95-96: `src\models\holographic\bulk_boundary.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 95 | 205 | `norm_x = torch.norm(x, dim=-1)` | distance_to_origin | ❌ NEEDS FIX |
| 96 | 281 | `norm_x = torch.norm(x, dim=-1, keepdim=True).clamp(...)` | Möbius scalar formula | ✅ CORRECT |

### 97: `src\models\lattice_projection.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 97 | 205 | `norms = torch.norm(adjusted_embeddings, dim=-1, keepdim=True)` | Radii adjustment | ❌ NEEDS FIX |

### 98-99: `src\models\mtl\gradnorm.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 98-99 | 141, 422 | `g.norm() ** 2`, `grad_i.norm() ** 2` | Gradient norms | ✅ CORRECT |

### 100: `src\models\mtl\task_heads.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 100 | 368 | `norm = all_emb.norm(dim=-1, keepdim=True)` | Drug correlations | ⚠️ REVIEW |

### 101: `src\models\padic_dynamics.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 101 | 193 | `norm = torch.norm(h, dim=-1, keepdim=True)` | Contractive projection | ✅ CORRECT |

### 102: `src\models\plm\hyperbolic_plm.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 102 | 170 | `x_norm = x.norm(dim=-1, keepdim=True).clamp(...)` | Ball projection | ✅ CORRECT |

### 103-104: `src\models\resistance_transformer.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 103-104 | 124, 292 | `x = self.norm(x)` | LayerNorm | ✅ CORRECT |

### 105: `src\models\simple_vae.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 105 | 219 | `v_norm = torch.clamp(torch.norm(v, ...), ...)` | exp_map formula | ✅ CORRECT |

### 106: `src\models\stable_transformer.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 106 | 525 | `print(f"Gradient norm: {x.grad.norm().item():.6f}")` | Debug gradient | ✅ CORRECT |

### 107-109: `src\models\tropical_hyperbolic_vae.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 107-109 | 134, 144, 398 | exp_map, log_map formulas | ✅ CORRECT |

### 110-112: `src\research\alphafold3\hybrid\structure_predictor.py`

| # | Line | Code | Category | Status |
|---|------|------|----------|--------|
| 110-112 | 287-289 | Inside `_poincare_distance` formula | ✅ CORRECT |

### 113-278: Research scripts (see next section)

---

## Research Scripts Summary

### Already fixed (inside hyperbolic_radius helper): ✅ CORRECT
- #113, 117, 120, 123-127, 143-145, 154, 159, 166, 174-176, 179-187, 196-197, 206-210, 213, 215-216, 220, 222-225, 230, 260, 263

### Intentionally Euclidean functions: ✅ CORRECT
- #128 (euclidean_distance), #143 (euclidean_distance), #160 (euclidean_distance), #163 (euclidean_distance), #201 (euclidean_full)

### p-adic norm (different object): ✅ CORRECT
- #149-153, #158

### Ball projection/clamping: ✅ CORRECT
- #139-142, 155-157, 190-192 (project_to_poincare, hyperbolic_centroid shift check)

### 3D physical/visualization coordinates: ✅ CORRECT
- #121-122, 177-178, 193-195, 211-212, 214, 217-219, 271-272

### Poincare distance formula (correct usage inside): ✅ CORRECT
- #135, 198-200, 202-205

### ❌ NEEDS FIX (radii on hyperbolic embeddings):
- #118-119 (03_hiv_handshake_analysis.py encode_context)
- #125-126 (analyze_tropism_switching.py centroid_distance, separation)
- #129-134 (esm2_integration.py - but these might be ESM2 Euclidean embeddings)
- #146-148 (hiv/src/03_hiv_handshake_analysis.py)
- #167-169 (03_citrullination_analysis.py euclidean_shift, cosine_sim)
- #170-173 (04_codon_optimizer.py cluster distances)
- #188-189 (cross_validate_encoder.py euc_context)
- #226-227 (04_fast_reverse_search.py radii, dists)
- #228-229, 232-234, 237-240, 243-246 (training/extraction scripts radii)
- #247-259 (spectral_analysis scripts radii, emb_dists)
- #261-262 (11_variational_orthogonality_test.py sample_radii)
- #264-265 (01_extract_compare_embeddings.py norms)
- #273-278 (visualization/projections/poincare.py norms, centroids)

---

## Summary Counts

| Status | Count | Percentage |
|--------|-------|------------|
| ✅ CORRECT | ~190 | 68% |
| ❌ NEEDS FIX | ~75 | 27% |
| ⚠️ REVIEW | ~13 | 5% |

---

## Priority Fix List (Core Files)

1. `src\losses\padic\metric_loss.py` - Line 84
2. `src\losses\padic\ranking_loss.py` - Lines 97-98
3. `src\losses\padic\ranking_v2.py` - Lines 131-132
4. `src\losses\set_theory_loss.py` - Line 105
5. `src\losses\objectives\solubility.py` - Line 231
6. `src\geometry\holographic_poincare.py` - Line 251
7. `src\models\holographic\bulk_boundary.py` - Line 205
8. `src\models\lattice_projection.py` - Line 205
9. `src\models\contrastive\concept_aware.py` - Line 445
10. `src\diseases\rheumatoid_arthritis.py` - Line 346
11. `src\encoders\codon_encoder.py` - Line 413
12. `src\visualization\projections\poincare.py` - Lines 67, 102, 108, 177, 260, 328
13. `src\visualization\plots\manifold.py` - Line 378

# V5.12.2 Hyperbolic Distance Audit

**Doc-Type:** Audit Tracking · Version 1.0 · Updated 2025-12-29

---

## Issue Summary

Euclidean `.norm()` was incorrectly used on hyperbolic Poincaré ball embeddings instead of proper `poincare_distance()`. This audit tracks all files requiring review/fix.

**Correct Formula:**
```python
# Hyperbolic distance from origin (radius)
d_H(0, x) = 2 * arctanh(sqrt(c) * ||x||) / sqrt(c)

# Hyperbolic distance between two points
d_H(x, y) = arccosh(1 + 2 * ||x-y||² / ((1-||x||²)(1-||y||²)))
```

**When Euclidean norm IS correct:**
- Direction extraction: `v / ||v||`
- Ball boundary clamping: `if ||x|| > 0.99`
- Visualization scaling
- Convergence checks
- Intentional Euclidean comparison functions

---

## FIXED FILES (39 research scripts)

### Batch 1-12 (Previous Session)
| File | Fixes |
|------|-------|
| `hiv/scripts/04_hiv_hiding_landscape.py` | 3 centroid radius |
| `hiv/scripts/06_validate_integrase_vulnerability.py` | 4 centroid radius |
| `hiv/scripts/esm2_integration.py` | 1 hyperbolic distance |
| `neurodegeneration/alzheimers/03_tau_vae_trajectory.py` | 2 centroid radii |
| `structural_validation/scripts/proteingym_pipeline.py` | 3 radii |
| `structural_validation/scripts/padic_dynamics_predictor.py` | 1 force constant |
| `structural_validation/scripts/ptm_mapping.py` | 2 radii |
| `structural_validation/scripts/resistance_pathways.py` | 1 poincare_distance |
| `rheumatoid_arthritis/scripts/03_citrullination_analysis.py` | 3 radial |
| `rheumatoid_arthritis/scripts/05_regenerative_axis_analysis.py` | 11 distances |
| `rheumatoid_arthritis/scripts/06_autoantigen_epitope_analysis.py` | 4 radius/distance |
| `rheumatoid_arthritis/scripts/07_citrullination_shift_analysis.py` | 2 centroid shift |
| `rheumatoid_arthritis/scripts/09_immunogenicity_analysis_augmented.py` | 1 norm |
| `rheumatoid_arthritis/scripts/11_immunogenicity_predictor.py` | 1 norm |
| `rheumatoid_arthritis/scripts/14_compute_geometric_features.py` | 1 norm |
| `rheumatoid_arthritis/scripts/15_predict_immunogenicity.py` | 1 norm |
| `rheumatoid_arthritis/scripts/18_goldilocks_validation.py` | 1 centroid |
| `rheumatoid_arthritis/scripts/25_combinatorial_ptm_analysis.py` | 1 relative shift |
| `rheumatoid_arthritis/scripts/26_triple_ptm_combinatorics.py` | 1 relative shift |
| `rheumatoid_arthritis/scripts/27_ptm_space_characterization.py` | 1 relative shift |
| `rheumatoid_arthritis/scripts/29_hierarchical_validation.py` | 1 centroid |
| `rheumatoid_arthritis/scripts/cross_validate_encoder.py` | 3 radius |
| `hiv/scripts/analyze_ctl_escape_expanded.py` | radii |
| `hiv/scripts/validate_encoder_comparison.py` | radii |
| `hiv/scripts/severity_prediction.py` | radii |
| `hiv/scripts/antibody_combinations.py` | radii |
| `hiv/scripts/analyze_tropism_switching.py` | radii |
| `structural_validation/scripts/mass_vs_property_benchmark.py` | radii |
| `structural_validation/scripts/kinetics_benchmark.py` | radii |
| `structural_validation/scripts/deep_physics_benchmark.py` | radii |
| `structural_validation/scripts/ddg_pytorch_training.py` | radii |
| `structural_validation/scripts/ddg_predictor_training.py` | radii |
| `structural_validation/scripts/ddg_benchmark.py` | radii |

### Batch 13 (This Session)
| File | Fixes |
|------|-------|
| `hiv/glycan_shield/01_glycan_sentinel_analysis.py` | 2 centroid shift |
| `hiv/src/glycan_shield/01_glycan_sentinel_analysis.py` | 2 centroid shift |
| `sars_cov_2/glycan_shield/02_handshake_interface_analysis.py` | 4 centroid norms |

### Batch 14 (This Session)
| File | Fixes |
|------|-------|
| `genetic_code/scripts/01_bioinformatics_analysis.py` | 1 radii |
| `genetic_code/scripts/02_genetic_code_padic.py` | 2 radii |
| `genetic_code/scripts/03_reverse_padic_search.py` | 5 (radii + centroid) |
| `genetic_code/scripts/06_learn_codon_mapping.py` | 1 pairwise distance |
| `genetic_code/scripts/08_find_natural_positions_v5_11_3.py` | 2 radii |

### Batch 15 (This Session)
| File | Fixes |
|------|-------|
| `embeddings_analysis/01_extract_compare_embeddings.py` | 2 radii |
| `spectral_analysis/11_variational_orthogonality_test.py` | 1 radii |

---

## VERIFIED CORRECT (No Fix Needed)

| File | Reason |
|------|--------|
| `structural_validation/scripts/padic_3d_dynamics.py` | 3D physical coordinates |
| `hiv/scripts/epistasis_prediction.py` | Has poincare_distance |
| `hiv/scripts/03_hiv_handshake_analysis.py` | Ball boundary clamping |
| `hiv/scripts/10_visualize_approach_clusters.py` | Visualization scaling |
| `rheumatoid_arthritis/scripts/01_hla_functionomic_analysis.py` | Intentional Euclidean |
| `rheumatoid_arthritis/scripts/02_hla_expanded_analysis.py` | Intentional Euclidean |
| `rheumatoid_arthritis/scripts/04_codon_optimizer.py` | Intentional Euclidean else |
| `rheumatoid_arthritis/scripts/10_immunogenicity_visualizations.py` | Visualization scaling |
| `rheumatoid_arthritis/visualizations/02_cluster_boundary_3d/generate.py` | 3D viz coords |
| `hiv/src/03_hiv_handshake_analysis.py` | Has compute_poincare_distance |
| `genetic_code/ARCHIVE_EUCLIDEAN/*` | Intentionally archived |

---

## NOT YET CHECKED - CORE SRC FILES

### Priority 1: Core Geometry/Metrics
- [ ] `src/core/geometry_utils.py`
- [ ] `src/core/metrics.py`
- [ ] `src/core/tensor_utils.py`
- [ ] `src/geometry/poincare.py`
- [ ] `src/geometry/holographic_poincare.py`

### Priority 2: Losses
- [ ] `src/losses/padic/ranking_loss.py`
- [ ] `src/losses/padic/ranking_v2.py`
- [ ] `src/losses/padic/metric_loss.py`
- [ ] `src/losses/hyperbolic_recon.py`
- [ ] `src/losses/set_theory_loss.py`
- [ ] `src/losses/epistasis_loss.py`
- [ ] `src/losses/objectives/solubility.py`
- [ ] `src/losses/objectives/manufacturability.py`

### Priority 3: Models
- [ ] `src/models/plm/hyperbolic_plm.py`
- [ ] `src/models/tropical_hyperbolic_vae.py`
- [ ] `src/models/epsilon_vae.py`
- [ ] `src/models/padic_dynamics.py`
- [ ] `src/models/lattice_projection.py`
- [ ] `src/models/base_vae.py`
- [ ] `src/models/simple_vae.py`
- [ ] `src/models/epistasis_module.py`
- [ ] `src/models/resistance_transformer.py`
- [ ] `src/models/gene_specific_vae.py`
- [ ] `src/models/stable_transformer.py`
- [ ] `src/models/holographic/bulk_boundary.py`
- [ ] `src/models/equivariant/layers.py`
- [ ] `src/models/equivariant/se3_encoder.py`
- [ ] `src/models/fusion/multimodal.py`
- [ ] `src/models/mtl/gradnorm.py`
- [ ] `src/models/mtl/task_heads.py`
- [ ] `src/models/contrastive/concept_aware.py`

### Priority 4: Encoders
- [ ] `src/encoders/padic_amino_acid_encoder.py`
- [ ] `src/encoders/codon_encoder.py`
- [ ] `src/encoders/motor_encoder.py`
- [ ] `src/encoders/geometric_vector_perceptron.py`

### Priority 5: Analysis/Visualization
- [ ] `src/analysis/evolution.py`
- [ ] `src/analysis/ancestry/geodesic_interpolator.py`
- [ ] `src/analysis/rotamer_stability.py`
- [ ] `src/analysis/protein_landscape.py`
- [ ] `src/analysis/extraterrestrial_aminoacids.py`
- [ ] `src/visualization/plots/manifold.py`
- [ ] `src/visualization/projections/poincare.py`

### Priority 6: Training/Optimization
- [ ] `src/training/monitoring/tensorboard_logger.py`
- [ ] `src/training/optimization/natural_gradient/fisher_optimizer.py`
- [ ] `src/training/grokking_detector.py`

### Priority 7: Experimental
- [ ] `src/_experimental/information/fisher_geometry.py`
- [ ] `src/_experimental/implementations/literature/literature_implementations.py`
- [ ] `src/_experimental/implementations/literature/advanced_literature_implementations.py`
- [ ] `src/_experimental/graphs/hyperbolic_gnn.py`
- [ ] `src/_experimental/equivariant/spherical_harmonics.py`
- [ ] `src/_experimental/equivariant/so3_layer.py`
- [ ] `src/_experimental/equivariant/se3_layer.py`
- [ ] `src/_experimental/diffusion/structure_gen.py`

### Priority 8: Disease-Specific
- [ ] `src/diseases/rheumatoid_arthritis.py`
- [ ] `src/research/alphafold3/hybrid/structure_predictor.py`

### Priority 9: Remaining Research Scripts
- [ ] `spectral_analysis/scripts/01_extract_embeddings.py`
- [ ] `spectral_analysis/scripts/04_padic_spectral_analysis.py`
- [ ] `spectral_analysis/scripts/05_exact_padic_analysis.py`
- [ ] `spectral_analysis/scripts/07_adelic_analysis.py`
- [ ] `spectral_analysis/scripts/08_alternative_spectral_operators.py`
- [ ] `spectral_analysis/scripts/09_binary_ternary_decomposition.py`
- [ ] `spectral_analysis/scripts/10_semantic_amplification_benchmark.py`
- [ ] `genetic_code/scripts/04_fast_reverse_search.py`
- [ ] `genetic_code/scripts/07_extract_v5_11_3_embeddings.py`
- [ ] `genetic_code/scripts/09_train_codon_encoder_3adic.py`
- [ ] `genetic_code/scripts/10_extract_fused_embeddings.py`
- [ ] `genetic_code/scripts/11_train_codon_encoder_fused.py`

### Priority 10: HIV Research Utils
- [ ] `hiv/scripts/hyperbolic_utils.py`
- [ ] `hiv/scripts/hyperbolic_nn.py`
- [ ] `hiv/src/hyperbolic_utils.py`
- [ ] `hiv/src/encoding/padic/distance.py`
- [ ] `hiv/src/encoding/encoder.py`
- [ ] `hiv/tests/unit/encoding/test_padic.py`
- [ ] `rheumatoid_arthritis/scripts/hyperbolic_utils.py`

---

## Audit Progress

| Category | Fixed | Verified OK | Not Checked | Total |
|----------|-------|-------------|-------------|-------|
| Research Scripts | 39 | 11 | ~20 | ~70 |
| Core src/ | 0 | 0 | ~60 | ~60 |
| **TOTAL** | 39 | 11 | ~80 | ~130 |

---

## Next Steps

1. Check Priority 1-2 files (core geometry + losses) - CRITICAL
2. Check Priority 3-4 files (models + encoders)
3. Check remaining research scripts
4. Final verification pass

---

*Last Updated: 2025-12-29*

# V5.12 Configuration: Highest Quality Ternary VAE
#
# Key improvements over V5.11:
# 1. RichHierarchyLoss as primary (preserves richness while maximizing hierarchy)
# 2. Tighter inner_radius (0.08) for better v=9 separation
# 3. Two-phase loss strategy (structure â†’ geometry refinement)
# 4. Enhanced homeostatic control with Q-tracking
# 5. ComprehensiveMetrics integration for checkpoint storage
#
# Target metrics:
# - Coverage: 100%
# - Hierarchy_B: -0.8321 (ceiling)
# - Richness: >0.008
# - r_v9: 0.12-0.15 (improved from 0.19)
# - dist_corr: >0.7

# Device Configuration
device:
  name: "v5_12_production"
  cuda_device: 0
  use_amp: false                       # Disable AMP for stability
  pin_memory: true
  num_workers: 4

# Model Architecture
model:
  name: TernaryVAEV5_11_PartialFreeze
  latent_dim: 16
  hidden_dim: 64
  max_radius: 0.95
  curvature: 1.0

  # V5.11+ features (all enabled for V5.12)
  use_controller: true
  use_dual_projection: true
  learnable_curvature: true
  manifold_aware: true

  # Projection network capacity
  projection_hidden_dim: 64
  projection_layers: 2
  projection_dropout: 0.1

# Option C: Partial Freeze (encoder_B trainable)
option_c:
  enabled: true
  encoder_b_lr_scale: 0.1
  encoder_a_lr_scale: 0.05             # For progressive unfreeze

# Frozen Checkpoint (from v5.5 with 100% coverage)
frozen_checkpoint:
  path: sandbox-training/checkpoints/v5_5/latest.pt
  encoder_to_load: both
  decoder_to_load: decoder_A

# Homeostatic Control (V5.11.7 + V5.11.8 + V5.12 enhancements)
homeostasis:
  enabled: true
  coverage_freeze_threshold: 0.995
  coverage_unfreeze_threshold: 1.0
  coverage_floor: 0.95
  warmup_epochs: 5
  hysteresis_epochs: 3

  # Q-gated annealing (slower for stability)
  enable_annealing: true
  annealing_step: 0.003                # Slower than V5.11 (0.005)

  # Hierarchy monitoring
  hierarchy_plateau_threshold: 0.001
  hierarchy_plateau_patience: 7        # More patience
  hierarchy_patience_ceiling: 20

  # Controller monitoring
  controller_grad_threshold: 0.01
  controller_grad_patience: 5

# Progressive Unfreezing (disabled - using homeostasis instead)
progressive_unfreeze:
  enabled: false

# Loss Configuration - V5.12 Two-Phase Strategy
loss:
  # PRIMARY: RichHierarchyLoss (preserves richness)
  rich_hierarchy:
    enabled: true
    hierarchy_weight: 5.0
    coverage_weight: 1.0
    richness_weight: 2.0
    separation_weight: 3.0
    min_richness_ratio: 0.5

  # AUXILIARY: Radial targets (tighter for V5.12)
  radial:
    enabled: true
    inner_radius: 0.08                 # Tighter than V5.11 (0.1)
    outer_radius: 0.90                 # Slightly expanded
    radial_weight: 1.0                 # Lower weight (RichHierarchy is primary)
    margin_weight: 0.5

  # Phase 2: Geodesic refinement (activates after epoch 50)
  geodesic:
    enabled: true
    phase_start_epoch: 50
    curvature: 1.0
    max_target_distance: 3.0
    n_pairs: 2000
    use_smooth_l1: true
    weight: 0.3                        # Low weight (auxiliary)

  # Structural constraint: Global rank loss
  rank:
    enabled: true
    weight: 0.5                        # Lower than V5.11 (1.0)
    temperature: 0.1
    n_pairs: 2000

  # Zero-structure loss (V5.11.9)
  zero_structure:
    enabled: true
    valuation_weight: 0.5
    sparsity_weight: 0.3

# Riemannian Optimization (geoopt)
riemannian:
  enabled: true
  optimizer: adam

# Training Configuration
training:
  epochs: 200
  batch_size: 512
  lr: 1.0e-3
  weight_decay: 1.0e-4

  # Gradient management
  max_grad_norm: 1.0

  # Stratified sampling (enhanced high-v budget)
  use_stratified: true
  high_v_budget_ratio: 0.25            # 25% for v>=4 (up from 20%)

  # Adaptive curriculum
  use_adaptive: true
  hierarchy_threshold: -0.75           # Freeze tau when reached
  patience: 25                         # More patience for V5.12
  min_epochs: 40

  # LR Scheduler
  scheduler:
    type: cosine_warmup_restart
    T_0: 25                            # Longer cycles
    T_mult: 2

  # Evaluation and checkpointing
  eval_every: 5
  save_every: 25
  print_every: 5

# Data Configuration
data:
  use_full_dataset: true
  n_operations: 19683

# Logging
logging:
  tensorboard: true
  log_dir: runs/v5_12_production
  print_every: 5

# Checkpoints
checkpoints:
  save_dir: sandbox-training/checkpoints/v5_12
  save_best: true
  best_metric: composite_score         # Custom: hierarchy + richness + dist_corr
  checkpoint_name: v5_12_production

# Success Criteria (V5.12 targets)
targets:
  coverage: 1.0                        # 100%
  hierarchy_B: -0.80                   # Target (ceiling is -0.8321)
  richness: 0.007                      # Minimum acceptable
  r_v9: 0.15                           # Maximum acceptable
  distance_correlation: 0.65           # Minimum acceptable
  Q_target: 1.8                        # Structure capacity

# Memory Optimization (8GB VRAM compatible)
memory:
  gradient_checkpointing: false
  empty_cache_freq: 10
  cudnn_benchmark: true

# Version tracking
version:
  model: "5.12"
  config: "1.0"
  date: "2025-12-29"

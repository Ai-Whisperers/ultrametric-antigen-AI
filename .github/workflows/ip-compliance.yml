name: IP Compliance Check

on:
  workflow_dispatch:

jobs:
  compliance:
    runs-on: ubuntu-latest
    name: IP & License Compliance

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Check copyright headers
        run: |
          python src/scripts/legal/add_copyright_headers.py --check
        continue-on-error: false

      - name: Check SPDX headers in documentation
        run: |
          echo "Checking SPDX headers in theory documentation..."
          MISSING=0
          for file in $(find DOCUMENTATION/01_PROJECT_KNOWLEDGE_BASE/02_THEORY_AND_FOUNDATIONS -name "*.md" 2>/dev/null); do
            if ! head -5 "$file" | grep -q "SPDX-License-Identifier"; then
              echo "MISSING SPDX: $file"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "ERROR: $MISSING files missing SPDX headers"
            echo "Run: python src/scripts/docs/add_spdx_frontmatter.py"
            exit 1
          fi
          echo "All documentation files have SPDX headers"

      - name: Verify required files exist
        run: |
          echo "Checking required legal files..."
          test -f LICENSE || (echo "ERROR: LICENSE file missing" && exit 1)
          test -f NOTICE || (echo "ERROR: NOTICE file missing" && exit 1)
          test -f CLA.md || (echo "ERROR: CLA.md file missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "ERROR: CONTRIBUTING.md missing" && exit 1)
          echo "All required files present"

      - name: Check for GPL dependencies
        run: |
          pip install -r requirements.txt
          echo "Checking for copyleft dependencies..."
          # This is informational - GPL deps may be okay depending on usage
          pip list --format=freeze | grep -iE "gpl|lgpl|agpl" || echo "No GPL dependencies found"

      - name: Scan for secrets
        run: |
          echo "Scanning for potential secrets..."
          # Check for common secret patterns
          if grep -rE "(api[_-]?key|secret[_-]?key|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.json" src/ 2>/dev/null; then
            echo "WARNING: Potential secrets found in code"
            exit 1
          fi
          echo "No secrets detected"

      - name: Verify NOTICE file is current
        run: |
          echo "Verifying third-party attribution..."
          # Check that NOTICE mentions AlphaFold3 if those files exist
          if [ -d "research/alphafold3" ]; then
            grep -q "AlphaFold" NOTICE || (echo "ERROR: AlphaFold not in NOTICE" && exit 1)
          fi
          echo "NOTICE file verified"

  license-check:
    runs-on: ubuntu-latest
    name: Dependency License Audit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pip-licenses
          pip install -r requirements.txt

      - name: Generate license report
        run: |
          pip-licenses --format=markdown --output-file=dependency-licenses.md
          echo "## Dependency Licenses" >> $GITHUB_STEP_SUMMARY
          cat dependency-licenses.md >> $GITHUB_STEP_SUMMARY

      - name: Check for incompatible licenses
        run: |
          # List of licenses incompatible with PolyForm Noncommercial
          INCOMPATIBLE="GPL-3.0|AGPL|SSPL"
          if pip-licenses --format=csv | grep -E "$INCOMPATIBLE"; then
            echo "WARNING: Potentially incompatible licenses detected"
            echo "Review dependency licenses for compatibility"
          else
            echo "No incompatible licenses detected"
          fi
